# MCP 连接架构和断线重连体系

## 架构概览

```
┌─────────────────────────────────────────────────────────────┐
│                     AI 编辑器客户端                           │
│         (Claude Desktop / Cursor / Windsurf)                 │
└────────────────┬────────────────────────────────────────────┘
                 │
                 │ MCP 协议
                 │ (Stdio / HTTP / SSE)
                 │
┌────────────────▼────────────────────────────────────────────┐
│                      本 MCP 服务器                           │
│  ┌──────────────────────────────────────────────────────┐  │
│  │            连接管理层                                 │  │
│  │  • 会话管理（Session Manager）                       │  │
│  │  • 心跳检测（Heartbeat Monitor）                     │  │
│  │  • 超时清理（Timeout Cleanup）                       │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │            MCP 协议处理层                            │  │
│  │  • 工具调用（Tool Execution）                        │  │
│  │  • 资源访问（Resource Access）                       │  │
│  │  • 提示词管理（Prompt Management）                   │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │            上游连接管理层                            │  │
│  │  • 上游连接（Upstream Connections）                  │  │
│  │  • 健康检查（Health Check）                          │  │
│  │  • 自动重连（Auto Reconnect）                        │  │
│  └──────────────────────────────────────────────────────┘  │
└────────────────┬────────────────────────────────────────────┘
                 │
                 │ MCP 协议
                 │
┌────────────────▼────────────────────────────────────────────┐
│                     上游 MCP 服务                            │
│         (Context7 / Figma / 自定义服务)                     │
└─────────────────────────────────────────────────────────────┘
```

## 三层断线重连机制

### 第一层：客户端 → 服务器连接

**责任方**：主要由客户端（AI 编辑器）负责

**服务端支持**：
1. **会话保持**
   - 通过 Session ID 识别客户端
   - 30 分钟会话超时（可配置）
   - 25 分钟时发送过期警告

2. **心跳机制**
   - 每 10 秒发送一次心跳
   - 检测连接是否活跃
   - 超时自动清理会话

3. **连接限制**
   - 最大 100 个并发连接
   - 每 IP 最多 10 个连接
   - 防止资源耗尽

**客户端行为**：
- **Stdio 模式**：进程退出时自动重启（由客户端实现）
- **HTTP/SSE 模式**：需要手动重连或实现自动重连逻辑

**配置位置**：
```json
// config/config.json
{
  "connection": {
    "heartbeat": {
      "intervalMs": 10000,      // 心跳间隔
      "timeoutMs": 30000        // 心跳超时
    },
    "session": {
      "maxIdleMs": 1800000,     // 会话最大空闲时间（30分钟）
      "cleanupIntervalMs": 120000 // 清理间隔（2分钟）
    }
  }
}
```

### 第二层：服务器内部处理

**责任方**：MCP 服务器（本系统）

**功能**：
1. **请求重试**
   - 上游调用失败时自动重试
   - 可配置重试次数和延迟
   - 指数退避策略

2. **错误恢复**
   - 捕获并处理上游错误
   - 降级策略（返回错误信息而非崩溃）
   - 日志记录和监控

3. **资源池管理**
   - 连接复用
   - 资源限制
   - 并发控制

### 第三层：服务器 → 上游连接

**责任方**：MCP 服务器（本系统）

**完整的自动重连机制**：

1. **健康监控**
   ```typescript
   // 定期检查上游连接健康状态
   heartbeatMs: 30000  // 每 30 秒检查一次
   ```

2. **断线检测**
   - 连接失败
   - 健康检查失败 3 次
   - 调用超时

3. **自动重连**
   ```typescript
   {
     "reconnect": {
       "enabled": true,
       "maxRetries": 5,           // 最大重试次数
       "initialDelayMs": 1000,    // 初始延迟 1 秒
       "maxDelayMs": 30000,       // 最大延迟 30 秒
       "factor": 2                // 延迟增长因子
     }
   }
   ```

4. **重连策略**
   - 指数退避：1s → 2s → 4s → 8s → 16s → 30s
   - 可配置为无限重试：`"maxRetries": "infinite"`
   - 重连成功后重置计数器

**配置示例**：
```json
{
  "upstreams": [
    {
      "name": "context7-proxy",
      "transport": "stdio",
      "enabled": true,
      "reconnect": {
        "enabled": true,
        "maxRetries": 5,
        "initialDelayMs": 1000,
        "maxDelayMs": 30000,
        "factor": 2,
        "heartbeatMs": 30000
      }
    }
  ]
}
```

## 连接状态流转

### 客户端连接状态

```
┌──────────┐
│   初始   │
└────┬─────┘
     │
     ▼
┌──────────┐     断线      ┌──────────┐
│  连接中  │──────────────▶│  断开    │
└────┬─────┘               └────┬─────┘
     │                          │
     │ 成功                     │ 重连
     ▼                          │
┌──────────┐     超时      ┌────▼─────┐
│  已连接  │──────────────▶│  过期    │
└────┬─────┘               └──────────┘
     │
     │ 心跳
     └──────┐
            │
            ▼
       保持活跃
```

### 上游连接状态

```
┌──────────┐
│   初始   │
└────┬─────┘
     │
     ▼
┌──────────┐     失败      ┌──────────┐
│  连接中  │──────────────▶│  重连中  │
└────┬─────┘               └────┬─────┘
     │                          │
     │ 成功                     │ 成功
     ▼                          │
┌──────────┐     健康检查失败   │
│  已连接  │──────────────────▶│
└────┬─────┘                   │
     │                          │
     │ 健康                     │
     └──────┐                   │
            │                   │
            ▼                   │
       监控健康 ◀────────────────┘
            │
            │ 失败3次
            ▼
       触发重连
```

## 监控和诊断

### 监控端点

1. **客户端会话状态**
   ```bash
   GET /api/mcp/sessions
   ```
   返回：活跃会话数、平均心跳数等

2. **系统诊断信息**
   ```bash
   GET /api/mcp/diagnostics
   ```
   返回：服务器状态、功能开关、上游数量

3. **上游连接状态**
   ```bash
   GET /api/upstream/status
   ```
   返回：每个上游的连接状态、健康检查、重连统计

### 日志监控

**关键日志模式**：

```bash
# 客户端连接
[mcp-sse] open: { session: "xxx" }
[mcp-sse] heartbeat sent: { sessionId: "xxx", pingCount: 10 }
[mcp-sse] connection closed: { sessionId: "xxx" }

# 会话管理
[mcp-sse] session idle timeout: { id: "xxx", idleMinutes: 30 }
[mcp-sse] session expiration warning sent: { id: "xxx" }

# 上游连接
[upstream] connected: { name: "context7", tools: [...] }
[upstream] health check failed: { name: "context7", consecutiveFailures: 3 }
[connection-manager] scheduling reconnect: { connectionId: "context7", attempt: 1 }
[connection-manager] reconnect successful: { connectionId: "context7" }
```

### 指标监控

建议监控的关键指标：

| 指标 | 类型 | 说明 | 告警阈值 |
|------|------|------|---------|
| `active_sessions` | Gauge | 活跃会话数 | > 80 |
| `session_timeout_rate` | Rate | 会话超时率 | > 10% |
| `heartbeat_failure_rate` | Rate | 心跳失败率 | > 5% |
| `upstream_connected` | Gauge | 上游连接状态 | = 0 |
| `reconnect_attempts` | Counter | 重连尝试次数 | > 10/min |
| `health_check_failures` | Counter | 健康检查失败 | > 5/min |

## 故障场景和处理

### 场景 1：客户端网络中断

**现象**：
- 心跳超时
- 请求失败
- 会话标记为不活跃

**自动处理**：
- 服务器：等待超时后清理会话
- 客户端：根据传输类型自动重连或手动重连

**人工干预**：
- 检查客户端网络
- 确认服务器可访问
- 重启客户端或刷新连接

### 场景 2：服务器重启

**现象**：
- 所有连接断开
- 所有会话清空

**自动处理**：
- Stdio 客户端：自动重启进程
- HTTP/SSE 客户端：显示连接错误

**人工干预**：
- HTTP/SSE 客户端需要手动重连
- 检查服务器启动日志

### 场景 3：上游服务不可用

**现象**：
- 工具调用失败
- 健康检查失败
- 触发自动重连

**自动处理**：
- 自动进入重连循环
- 按指数退避策略重试
- 记录详细日志

**人工干预**：
- 检查上游服务状态
- 查看重连统计：`GET /api/upstream/status`
- 必要时手动触发重连：`POST /api/upstream/reconnect/:name`

### 场景 4：并发连接过多

**现象**：
- 新连接被拒绝
- 返回 503 错误

**自动处理**：
- 拒绝超出限制的连接
- 清理过期会话释放资源

**人工干预**：
- 增加连接限制配置
- 检查是否有连接泄漏
- 优化客户端连接管理

## 最佳实践总结

### 1. 客户端配置

✅ **推荐做法**：
- 本地开发使用 Stdio 模式（最稳定）
- 远程服务器使用 SSE 模式
- 配置合理的超时时间

❌ **避免**：
- 不要频繁重连
- 不要同时开启过多连接
- 不要忽略连接错误

### 2. 服务端配置

✅ **推荐做法**：
- 启用上游自动重连
- 配置合理的心跳间隔
- 设置适当的会话超时
- 启用详细日志记录

❌ **避免**：
- 不要禁用心跳机制
- 不要设置过短的超时时间
- 不要忽略健康检查

### 3. 监控告警

✅ **推荐做法**：
- 监控关键指标
- 设置合理的告警阈值
- 定期查看日志
- 使用诊断 API

❌ **避免**：
- 不要等到故障发生才检查
- 不要忽略警告信息
- 不要禁用日志记录

## 相关文档

- [断线重连机制](reconnection.md) - 上游连接的详细配置
- [AI 编辑器客户端断线重连指南](client-reconnection.md) - 客户端配置指南
- [配置参考](../config/config.json) - 完整配置示例

## 技术支持

如果遇到连接问题：

1. **查看日志**：`tail -f logs/app.log`
2. **检查状态**：访问诊断 API
3. **测试连接**：使用 curl 测试端点
4. **查阅文档**：参考相关文档
5. **提交问题**：提供详细的日志和配置信息

